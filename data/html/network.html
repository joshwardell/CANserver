<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="data:,">
        <link rel="stylesheet" type="text/css" href="/css/app.css">
        <script src="/js/app.js"></script>
        
        <title>Network Config</title>
    </head>
    <body>
      <main id="network">
          <div id="networkparams">
            <div id="loading">Loading...</div>
            <form action="/network_save" method="POST" id="settingsform" class="hidden">
              <label>External SSID: </label><input name="ssid" id="ssid"/> *To disable external wifi connectivity just make sure this box is empty<br>
              <label>External Password: </label><input name="password" id="password"/> *saved password isn't displayed.  If you leave it empty and hit save it will be removed<br>
              <br>
              <button type="submit">Save</button>
            </form>
            
            <h3>Connected Clients</h3>
            <div id="stationlist">
              Loading...
            </div>
          </div>
        </main>

        <script>
          const networkEl = document.getElementById('network');

          if (networkEl) {
            // load network data
            getJSON('/network_update').then(data => {
              if ('networksettings' in data) {
                  Object.keys(data.networksettings).forEach(id => {
                      const input = networkEl.querySelector('input#' + id);
                      input && (input.value = data.networksettings[id]);
                  });

                  hide(networkEl.querySelector('div#loading'));
                  show(networkEl.querySelector('form#settingsform'));
              }
            });
          
            let fetchingClients = false;

            const loadClients = () => {
              const stationListEl = network.querySelector('#stationlist');
              stationListEl.innerText = '';

              // avoid building a big backlog of requests if server is slow
              if (!fetchingClients) {
                fetchingClients = true;

                getJSON('/network_stationlist').then(data => {
                  if ('stations' in data) {
                    const stations = data.stations;

                    if (stations.length === 0) {
                      stationListEl.innerText = 'No connected clients';
                    } else {
                      const listEl = el('ul', {
                        children: Object.keys(stations).map(stationId => {
                          const station = stations[stationId];
                          return station && el('li', { inner: station.mac + ' - ' + station.ip });
                        }).filter(Boolean)
                      })

                      stationListEl.appendChild(listEl);
                    }
                  }
                  fetchingClients = false;
                })
              }
            }

            // load clients data
            loadClients();

            // refresh clients data
            setInterval(loadClients, 5000);
          }
        </script>
    </body>
</html>